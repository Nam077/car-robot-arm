<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>

<body>
    <div class="container">
        <div class="left">
            <div class="dpad-grid">
                <button data-action="HL" class="dpad-button">↖</button> <!-- Top-left -->
                <button data-action="U" class="dpad-button main-button">&#x25B2</button> <!-- Up -->
                <button data-action="TR" class="dpad-button">↗</button> <!-- Top-right -->
                <button data-action="L" class="dpad-button main-button">&#x25C0</button> <!-- Left -->
                <button data-action="S" class="dpad-button main-button">&#9724</button> <!-- Center -->
                <button data-action="R" class="dpad-button main-button">&#x25B6</button> <!-- Right -->
                <button data-action="BL" class="dpad-button">↙</button> <!-- Bottom-left -->
                <button data-action="D" class="dpad-button main-button">&#x25BC</button> <!-- Down -->
                <button data-action="BR" class="dpad-button">↘</button> <!-- Bottom-right -->
            </div>
        </div>
        <div class="main"></div>
        <div class="right">

        </div>
    </div>
    <script>

    </script>
    <script>
        var socket = new WebSocket("ws://192.168.1.21/ws");

        socket.onopen = function (event) {
            console.log("WebSocket connection opened.");
        };

        socket.onmessage = function (event) {
            console.log("Message received: " + event.data);
            var messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += "<p>" + event.data + "</p>";
        };

        socket.onclose = function (event) {
            console.log("WebSocket connection closed.");
        };

        socket.onerror = function (error) {
            console.error("WebSocket error: " + error.message);
        };

        var interval; // Biến toàn cục để theo dõi interval

        function sendAction(action) {
            socket.send(JSON.stringify({ type: "control", action: action }));
        }
        function sendAngle(servoPin, angle) {
            socket.send(JSON.stringify({
                type: "servo",
                servoPin: servoPin,
                angle: angle
            }));
        }

        // Xử lý sự kiện mousedown và touchstart cho nút điều khiển
        function handleButtonPress(button) {
            var action = button.getAttribute("data-action");
            sendAction(action); // Gửi hành động ngay lập tức

            // Dừng bất kỳ interval trước đó
            if (interval) clearInterval(interval);

            // Thiết lập một interval mới
            interval = setInterval(function () {
                sendAction(action);
            }, 500); // Ajust the interval time as needed

            // Đăng ký sự kiện để dừng interval khi nút được thả
            var stopAction = function () {
                clearInterval(interval);
                // Hủy đăng ký sự kiện để tránh rò rỉ bộ nhớ
                document.removeEventListener("mouseup", stopAction);
                document.removeEventListener("touchend", stopAction);
            };

            document.addEventListener("mouseup", stopAction);
            document.addEventListener("touchend", stopAction);
        }
        function handleInputChange(event) {
            let value = event.target.value;
            let servoPin = event.target.getAttribute('data-servo-pin');
            sendAngle(servoPin, value);
        }
        function getInputFromServer() {
            let right = document.querySelector('.right');
            fetch('/getInput')
                .then(response => response.json())
                .then(data => {
                    let input = data.input;
                    right.innerHTML = input;
                    let inputRanges = document.querySelectorAll('.input-range');
                    inputRanges.forEach(function (inputRange) {
                        inputRange.addEventListener('input', handleInputChange);
                    });
                });
        }



        document.addEventListener('DOMContentLoaded', function () {
            getInputFromServer();
            var dpadButtons = document.querySelectorAll(".dpad-button");
            dpadButtons.forEach(function (button) {
                button.addEventListener("mousedown", function () {
                    handleButtonPress(button);
                });
                button.addEventListener("touchstart", function (e) {
                    e.preventDefault(); // Ngăn chặn cuộn hoặc zoom trên màn hình cảm ứng
                    handleButtonPress(button);
                });
            });
        });


    </script>

</body>


</html>